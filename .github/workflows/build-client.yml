name: Build frontend folder

on:
  pull_request:
    branches: [main]

defaults:
  run:
    shell: bash

jobs:
  security-checks:
    runs-on: ubuntu-latest
    outputs:
      vulnerabilities: ${{ steps.frontend-scan.outputs.vulnerabilities }}
      critical: ${{ steps.frontend-scan.outputs.critical }}
      high: ${{ steps.frontend-scan.outputs.high }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node (Security Checks)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install tools (jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Frontend Security Scan (npm audit)
        id: frontend-scan
        working-directory: ./frontend
        run: |
          npm ci
          npm audit --audit-level=high --json > audit-report.json || true

          vulnerabilities=$(jq -r '.metadata.vulnerabilities.total // 0' audit-report.json)
          critical=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-report.json)
          high=$(jq -r '.metadata.vulnerabilities.high // 0' audit-report.json)

          echo "vulnerabilities=$vulnerabilities" >> $GITHUB_OUTPUT
          echo "critical=$critical" >> $GITHUB_OUTPUT
          echo "high=$high" >> $GITHUB_OUTPUT

          echo "Vulnerabilities total: $vulnerabilities"
          echo "Critical: $critical"
          echo "High: $high"

          if [[ "$critical" -gt 0 ]] || [[ "$high" -gt 0 ]]; then
            echo "âŒ SECURITY GATE FAILED: Critical or High vulnerabilities found"
            exit 1
          fi

  build:
    runs-on: ubuntu-latest
    needs: security-checks
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node (Build)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install deps
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Run frontend tests (placeholder)
        working-directory: ./frontend
        run: npm test -- --passWithNoTests

  notify:
    name: Email teachers (single notify)
    runs-on: ubuntu-latest
    needs: [security-checks, build]
    if: always()

    steps:
      - name: Send email via SMTP
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}

          WORKFLOW: ${{ github.workflow }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.head_ref }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          SECURITY_STATUS: ${{ needs.security-checks.result }}
          BUILD_STATUS: ${{ needs.build.result }}

          VULNS_TOTAL: ${{ needs.security-checks.outputs.vulnerabilities }}
          VULNS_CRIT: ${{ needs.security-checks.outputs.critical }}
          VULNS_HIGH: ${{ needs.security-checks.outputs.high }}

        run: |
          set -e

          # Validate env (no secret printing)
          [ -n "$SMTP_HOST" ] || (echo "SMTP_HOST missing" && exit 1)
          [ -n "$SMTP_PORT" ] || (echo "SMTP_PORT missing" && exit 1)
          [ -n "$SMTP_USER" ] || (echo "SMTP_USER missing" && exit 1)
          [ -n "$SMTP_PASS" ] || (echo "SMTP_PASS missing" && exit 1)
          [ -n "$EMAIL_FROM" ] || (echo "EMAIL_FROM missing" && exit 1)

          EMAIL_TO_CLEAN="$(echo "$EMAIL_TO" | tr -d ' \n\r\t')"
          [ -n "$EMAIL_TO_CLEAN" ] || (echo "EMAIL_TO missing/blank, skipping email." && exit 0)

          sudo apt-get update
          sudo apt-get install -y msmtp msmtp-mta ca-certificates

          cat > ~/.msmtprc <<EOF
          defaults
          auth on
          tls on
          tls_starttls on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt

          account smtp
          host $SMTP_HOST
          port $SMTP_PORT
          user $SMTP_USER
          password $SMTP_PASS
          from $EMAIL_FROM

          account default : smtp
          EOF
          chmod 600 ~/.msmtprc

          OVERALL="PASS"
          if [ "$SECURITY_STATUS" != "success" ] || [ "$BUILD_STATUS" != "success" ]; then
            OVERALL="FAIL"
          fi

          SUBJECT="[$OVERALL] $WORKFLOW - $REPO ($BRANCH)"
          BODY="Hello,\n\nAutomated CI notification.\n\nWorkflow: $WORKFLOW\nRepository: $REPO\nPR Branch: $BRANCH\nTriggered by: $ACTOR\n\nJob results:\n- security-checks: $SECURITY_STATUS (total=$VULNS_TOTAL, critical=$VULNS_CRIT, high=$VULNS_HIGH)\n- build: $BUILD_STATUS\n\nRun link: $RUN_URL\n\nRegards,\nDevOps Team"

          printf "To: %s\nFrom: %s\nSubject: %s\n\n%s\n" \
            "$EMAIL_TO" "$EMAIL_FROM" "$SUBJECT" "$BODY" | msmtp -t
