name: Security Scan

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    outputs:
      frontend_failed: ${{ steps.sca_frontend.outputs.failed }}
      backend_failed: ${{ steps.sca_backend.outputs.failed }}

    steps:
      - uses: actions/checkout@v4

      # SAST
      - name: Run SAST (Semgrep)
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/ci

      # SCA Frontend
      - name: Install frontend deps
        working-directory: ./frontend
        run: npm ci

      - name: Run SCA (frontend npm audit)
        id: sca_frontend
        working-directory: ./frontend
        run: |
          npm audit --audit-level=high --json > audit-frontend.json || true
          total=$(node -e "const r=require('./audit-frontend.json'); console.log((r.metadata?.vulnerabilities?.total) ?? 0)")
          critical=$(node -e "const r=require('./audit-frontend.json'); console.log((r.metadata?.vulnerabilities?.critical) ?? 0)")
          high=$(node -e "const r=require('./audit-frontend.json'); console.log((r.metadata?.vulnerabilities?.high) ?? 0)")

          echo "total=$total critical=$critical high=$high"
          if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
          else
            echo "failed=false" >> $GITHUB_OUTPUT
          fi

      # SCA Backend
      - name: Install backend deps
        working-directory: ./backend
        run: npm ci

      - name: Run SCA (backend npm audit)
        id: sca_backend
        working-directory: ./backend
        run: |
          npm audit --audit-level=high --json > audit-backend.json || true
          total=$(node -e "const r=require('./audit-backend.json'); console.log((r.metadata?.vulnerabilities?.total) ?? 0)")
          critical=$(node -e "const r=require('./audit-backend.json'); console.log((r.metadata?.vulnerabilities?.critical) ?? 0)")
          high=$(node -e "const r=require('./audit-backend.json'); console.log((r.metadata?.vulnerabilities?.high) ?? 0)")

          echo "total=$total critical=$critical high=$high"
          if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
          else
            echo "failed=false" >> $GITHUB_OUTPUT
          fi

      # Secret scanning
      - name: Secret Scanning (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.sha }}
          head: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      # Dependency review (PR only)
      - name: Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4

      # Security gate at end (so email can still send from notify job)
      - name: Enforce security gate (fail if audit failed)
        run: |
          if [ "${{ steps.sca_frontend.outputs.failed }}" = "true" ] || [ "${{ steps.sca_backend.outputs.failed }}" = "true" ]; then
            echo "❌ SECURITY GATE FAILED: High/Critical vulnerabilities detected"
            exit 1
          fi
          echo "✅ Security gate passed"

  notify:
    name: Email teachers (single notify)
    runs-on: ubuntu-latest
    needs: [scan]
    if: always()

    steps:
      - name: Send email via Outlook SMTP
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}

          WORKFLOW: ${{ github.workflow }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          SCAN_STATUS: ${{ needs.scan.result }}
          FE_FAILED: ${{ needs.scan.outputs.frontend_failed }}
          BE_FAILED: ${{ needs.scan.outputs.backend_failed }}

        run: |
          set -e
          EMAIL_TO_CLEAN="$(echo "$EMAIL_TO" | tr -d ' \n\r\t')"
          if [ -z "$EMAIL_TO_CLEAN" ]; then
            echo "EMAIL_TO is empty. Skipping email to avoid msmtp error."
            exit 0
          fi

          sudo apt-get update
          sudo apt-get install -y msmtp msmtp-mta ca-certificates

          cat > ~/.msmtprc <<EOF
          defaults
          auth on
          tls on
          tls_starttls on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt

          account smtp
          host $SMTP_HOST
          port $SMTP_PORT
          user $SMTP_USER
          password $SMTP_PASS
          from $EMAIL_FROM

          account default : smtp
          EOF
          chmod 600 ~/.msmtprc

          OVERALL="PASS"
          if [ "$SCAN_STATUS" != "success" ]; then OVERALL="FAIL"; fi

          SUBJECT="[$OVERALL] $WORKFLOW - $REPO ($BRANCH)"
          BODY="Hello,\n\nAutomated security scan notification.\n\nWorkflow: $WORKFLOW\nRepository: $REPO\nBranch: $BRANCH\nTriggered by: $ACTOR\n\nJob results:\n- scan: $SCAN_STATUS\n\nAudit flags:\n- frontend audit failed: ${FE_FAILED:-unknown}\n- backend audit failed: ${BE_FAILED:-unknown}\n\nRun link: $RUN_URL\n\nRegards,\nDevOps Team"

          printf "To: %s\nFrom: %s\nSubject: %s\n\n%s\n" \
            "$EMAIL_TO" "$EMAIL_FROM" "$SUBJECT" "$BODY" | msmtp -t
